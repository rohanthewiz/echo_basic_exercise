test:
  pre:
    - mkdir -p /home/ubuntu/.go_workspace/src/github.com/jstemmer
    - go get -u github.com/jstemmer/go-junit-report
    - echo -e "[postgres]\nhost=\"localhost\"\nport=5432\nuser=\"ubuntu\"\ndbname=\"sqlboiler\"\n[mysql]\nhost=\"localhost\"\nport=3306\nuser=\"ubuntu\"\ndbname=\"sqlboiler\"\nsslmode=\"false\"" > sqlboiler.toml
    - createdb -U ubuntu sqlboiler
    - psql -U ubuntu sqlboiler < ./testdata/postgres_test_schema.sql
    - echo "create database sqlboiler;" | mysql -u ubuntu
    - mysql -u ubuntu sqlboiler < ./testdata/mysql_test_schema.sql
    - ./sqlboiler postgres -o "postgres"
    - ./sqlboiler postgres -o "mysql"
  override:
    - go test -v -race ./... > $CIRCLE_ARTIFACTS/gotest.txt
  post:
    - cat $CIRCLE_ARTIFACTS/gotest.txt | go-junit-report > $CIRCLE_TEST_REPORTS/junit.xml

machine:
  environment:
    GODIST: "go1.7.linux-amd64.tar.gz"
  post:
    - mkdir -p download
    - test -e download/$GODIST || curl -o download/$GODIST https://storage.googleapis.com/golang/$GODIST
    - sudo rm -rf /usr/local/go
    - sudo tar -C /usr/local -xzf download/$GODIST

dependencies:
  cache_directories:
    - ~/download
